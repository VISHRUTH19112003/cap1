/**
 * @fileoverview Firestore Security Rules for NyayaGPT application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user has complete control over their own data tree,
 * while other users are denied access. All writes are validated against the authenticated user's ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring clear ownership. This includes user profiles, documents, search queries,
 * legal arguments, contract analyses, and settings.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to prevent unauthorized access to user data.
 * - All data is private by default. No public collections are defined.
 * - All write operations require authentication and authorization based on the user ID in the path.
 *
 * Authorization Denormalization:
 * The rules rely on path-based ownership. The authenticated user's ID is compared to the userId path parameter to grant access.
 * No additional database reads (get() calls) are needed for authorization, ensuring optimal performance and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profile data. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Explicitly prevent listing all users

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user documents. Only the authenticated user can read or write their own documents.
     * @path /users/{userId}/documents/{documentId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/documents/{documentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user legal search queries. Only the authenticated user can read or write their own legal search queries.
     * @path /users/{userId}/legalSearchQueries/{legalSearchQueryId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/legalSearchQueries/{legalSearchQueryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user legal arguments. Only the authenticated user can read or write their own legal arguments.
     * @path /users/{userId}/legalArguments/{legalArgumentId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/legalArguments/{legalArgumentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user contract analyses. Only the authenticated user can read or write their own contract analyses.
     * @path /users/{userId}/contractAnalyses/{contractAnalysisId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contractAnalyses/{contractAnalysisId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for user settings. Only the authenticated user can read or write their own settings.
     * @path /users/{userId}/settings/{settingId}
     * @allow (create, update, delete): If the authenticated user's ID matches the userId in the path.
     * @allow (get, list): If the authenticated user's ID matches the userId in the path.
     * @deny (create, update, delete): If the authenticated user's ID does not match the userId in the path.
     * @deny (get, list): If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/settings/{settingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }
  }
}